name: Cosmic Container Forge
 
on:
  push:
    branches: ["**"]
  workflow_dispatch:
 
env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}/stellar-apps
 
jobs:
  build-and-containerize:
    runs-on: ubuntu-latest
 
    strategy:
      matrix:
        include:
          - lang: java
            dockerfile: dockeryard/java.orbit.dockerfile
            context: .
          - lang: node
            dockerfile: dockeryard/node.nebula.dockerfile
            context: .
          - lang: python
            dockerfile: dockeryard/python.stardust.dockerfile
            context: .
 
    steps:
      - name:  Checkout Code
        uses: actions/checkout@v4
 
      - name: ðŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
 
      - name:  Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
 
      # ===== Language Dependency Cache =====
 
      - name:  Cache Maven
        if: matrix.lang == 'java'
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ hashFiles('**/pom.xml') }}
 
      - name:  Cache NPM
        if: matrix.lang == 'node'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('**/package-lock.json') }}
 
      - name:  Cache PIP
        if: matrix.lang == 'python'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('**/requirements.txt') }}
 
      # ===== Docker Image Tags =====
 
      - name:  Generate Tags
        id: tags
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          BRANCH=$(echo $GITHUB_REF_NAME | tr '/' '-')
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:${{ matrix.lang }}-${SHORT_SHA},${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:${{ matrix.lang }}-${BRANCH}"
          if [ "$BRANCH" = "main" ]; then
            TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}:${{ matrix.lang }}-latest"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
 
      # ===== Docker Build =====
 
      - name:  Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
